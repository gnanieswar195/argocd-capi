apiVersion: batch/v1
kind: Job
metadata:
  name: capi-management-cluster-setup
spec:
  template:
    spec:
      containers:
      - name: capi-management-cluster-setup
        image: alpine:3.18
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Install necessary packages
            apk add --no-cache jq curl

            # Fetch the latest version tag
            latest_version=$(curl -s https://api.github.com/repos/kubernetes-sigs/cluster-api/releases/latest | jq -r '.tag_name')

            # Verify the version tag was fetched correctly
            if [ -z "$latest_version" ]; then
              echo "Failed to fetch the latest version of clusterctl"
              exit 1
            fi

            # Download the latest clusterctl binary
            curl -L "https://github.com/kubernetes-sigs/cluster-api/releases/download/${latest_version}/clusterctl-linux-amd64" -o /usr/local/bin/clusterctl

            # Ensure the binary is downloaded
            if [ ! -f "/usr/local/bin/clusterctl" ]; then
              echo "Failed to download clusterctl"
              exit 1
            fi

            # Make the binary executable
            chmod +x /usr/local/bin/clusterctl

            # Verify the installation
            /usr/local/bin/clusterctl version

            # Set environment variables
            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            export CLUSTER_TOPOLOGY=true

            # Initialize the management cluster
            /usr/local/bin/clusterctl init --infrastructure openstack
        volumeMounts:
        - name: kubeconfig
          mountPath: /etc/rancher/rke2
        restartPolicy: OnFailure
      volumes:
      - name: kubeconfig
        hostPath:
          path: /etc/rancher/rke2
          type: Directory
