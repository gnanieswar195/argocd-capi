apiVersion: batch/v1
kind: Job
metadata:
  name: capi-management-cluster-setup
spec:
  template:
    spec:
      containers:
      - name: capi-management-cluster-setup
        image: alpine:3.18
        command: ["/bin/sh", "-c"]
        args:
          - |
            if [ -f /etc/rancher/rke2/setup-complete ]; then
              echo "Setup already completed, skipping..."
              exit 0
            fi

            apk add --no-cache jq curl
            latest_version=$(curl -s https://api.github.com/repos/kubernetes-sigs/cluster-api/releases/latest | jq -r '.tag_name')
            if [ -z "$latest_version" ]; then
              echo "Failed to fetch the latest version of clusterctl"
              exit 1
            fi

            curl -L "https://github.com/kubernetes-sigs/cluster-api/releases/download/${latest_version}/clusterctl-linux-amd64" -o /usr/local/bin/clusterctl
            if [ ! -f "/usr/local/bin/clusterctl" ]; then
              echo "Failed to download clusterctl"
              exit 1
            fi

            chmod +x /usr/local/bin/clusterctl
            CONTROL_PLANE_IP=10.230.23.37
            sed -i "s/127.0.0.1/${CONTROL_PLANE_IP}/g" /etc/rancher/rke2/rke2.yaml

            export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
            export CLUSTER_TOPOLOGY=true

            /usr/local/bin/clusterctl version
            /usr/local/bin/clusterctl init --infrastructure openstack

            touch /etc/rancher/rke2/setup-complete
            exit 0
      restartPolicy: Never
      volumes:
      - name: kubeconfig
        hostPath:
          path: /etc/rancher/rke2
          type: Directory
